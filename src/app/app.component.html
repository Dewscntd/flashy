<tui-root class="app-shell">
  <app-toast-notification></app-toast-notification>

  <main id="main-content" class="container">
    <!-- Skip to main content link for keyboard accessibility (WCAG 2.4.1) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="header">
      <div class="title-block">
        <span class="eyebrow">{{ 'app.subtitle' | translate }}</span>
        <h1 class="main-title">{{ 'app.title' | translate }}</h1>
      </div>
      <div class="header-controls">
        @defer (on interaction) {
          <app-language-switcher></app-language-switcher>
        } @placeholder {
          <div class="language-placeholder" role="button" aria-label="Language switcher loading">
            <span class="language-code">{{ 'en' }}</span>
          </div>
        }
        <app-theme-toggle class="theme-toggle-wrapper"></app-theme-toggle>
      </div>
    </div>

    <div class="builder-area">
      <!-- URL Form Builder -->
      <form
        [formGroup]="form"
        class="form-card"
        (ngSubmit)="$event.preventDefault()"
        novalidate>

        <!-- Base URL Field -->
        <div class="form-group">
          <label for="baseUrl">{{ 'urlBuilder.form.baseUrl.label' | translate }} <span class="required">*</span></label>
          <input
            id="baseUrl"
            type="url"
            formControlName="baseUrl"
            [placeholder]="'urlBuilder.form.baseUrl.placeholder' | translate"
            [attr.aria-invalid]="form.get('baseUrl')?.invalid && form.get('baseUrl')?.touched"
            aria-describedby="baseUrl-error">
          <small id="baseUrl-error" class="error" role="alert">
            @if (form.get('baseUrl')?.invalid && form.get('baseUrl')?.touched) {
              {{ 'urlBuilder.form.baseUrl.error' | translate }}
            }
          </small>
        </div>

        <!-- UTM Parameters -->
        <fieldset class="utm-fieldset">
          <legend>{{ 'urlBuilder.form.utmParams.legend' | translate }}</legend>

          <div class="form-row">
            <div class="form-group">
              <label for="utmSource">{{ 'urlBuilder.form.utmParams.source.label' | translate }}</label>
              <input
                id="utmSource"
                type="text"
                formControlName="utmSource"
                [placeholder]="'urlBuilder.form.utmParams.source.placeholder' | translate">
            </div>

            <div class="form-group">
              <label for="utmMedium">{{ 'urlBuilder.form.utmParams.medium.label' | translate }}</label>
              <input
                id="utmMedium"
                type="text"
                formControlName="utmMedium"
                [placeholder]="'urlBuilder.form.utmParams.medium.placeholder' | translate">
            </div>

            <div class="form-group">
              <label for="utmCampaign">{{ 'urlBuilder.form.utmParams.campaign.label' | translate }}</label>
              <input
                id="utmCampaign"
                type="text"
                formControlName="utmCampaign"
                [placeholder]="'urlBuilder.form.utmParams.campaign.placeholder' | translate">
            </div>
          </div>
        </fieldset>

        <!-- Dynamic Parameters Component -->
        <app-dynamic-params
          [paramsArray]="params"
          [onAdd]="onAddParameter.bind(this)"
          [onRemove]="onRemoveParameter.bind(this)">
        </app-dynamic-params>
      </form>

      <!-- Live URL Preview Component -->
      <app-url-preview
        [urlData]="constructedUrl()"
        [saveDisabled]="!canSave()"
        [shorteningInProgress]="shorteningInProgress()"
        [shortenedUrl]="shortenedUrl()"
        [qrCodeVisible]="qrCodeVisible()"
        [qrCodeGenerating]="qrCodeGenerating()"
        [qrCodeOptions]="qrCodeOptions()"
        (copyClicked)="onCopyUrl()"
        (saveClicked)="onSaveBuild()"
        (shortenClicked)="onShortenUrl()"
        (qrCodeRequested)="onGenerateQrCode()"
        (qrCodeDownloadRequested)="onDownloadQrCode($event)"
        (qrCodeCopyRequested)="onCopyQrCode()"
        (qrCodeOptionsChanged)="onQrCodeOptionsChange($event)">
      </app-url-preview>
    </div>

    <!-- History Component (Deferred Loading) -->
    <div class="history-area">
      @defer (on viewport; prefetch on idle) {
        <app-history (loadBuild)="onLoadBuild($event)"></app-history>
      } @placeholder (minimum 500ms) {
        <div class="placeholder-card">
          <span class="placeholder-icon">⌛</span>
          {{ 'history.loading' | translate }}
        </div>
      } @loading (minimum 500ms; after 100ms) {
        <div class="loading-card">
          <div class="spinner"></div>
          {{ 'common.labels.loading' | translate }}
        </div>
      } @error {
        <div class="error-card">
          <span class="placeholder-icon">⚠</span>
          {{ 'history.error' | translate }}
        </div>
      }
    </div>
  </main>
</tui-root>
