<app-toast-notification></app-toast-notification>

<main class="container">
  <div class="header">
    <h1 class="main-title">URL Builder</h1>
    <app-theme-toggle class="theme-toggle-wrapper"></app-theme-toggle>
  </div>

  <div class="builder-area">
    <!-- URL Form Builder -->
    <form [formGroup]="form" class="form-container" (ngSubmit)="$event.preventDefault()">

      <!-- Base URL Field -->
      <div class="form-group">
        <label for="baseUrl">Base URL <span class="required">*</span></label>
        <input
          id="baseUrl"
          type="url"
          formControlName="baseUrl"
          placeholder="https://example.com"
          [attr.aria-invalid]="form.get('baseUrl')?.invalid && form.get('baseUrl')?.touched"
          aria-describedby="baseUrl-error">
        @if (form.get('baseUrl')?.invalid && form.get('baseUrl')?.touched) {
          <small id="baseUrl-error" class="error" role="alert">
            A valid absolute URL is required
          </small>
        }
      </div>

      <!-- UTM Parameters -->
      <fieldset class="utm-fieldset">
        <legend>UTM Parameters (Optional)</legend>

        <div class="form-row">
          <div class="form-group">
            <label for="utmSource">utm_source</label>
            <input
              id="utmSource"
              type="text"
              formControlName="utmSource"
              placeholder="e.g., google, newsletter">
          </div>

          <div class="form-group">
            <label for="utmMedium">utm_medium</label>
            <input
              id="utmMedium"
              type="text"
              formControlName="utmMedium"
              placeholder="e.g., cpc, email">
          </div>

          <div class="form-group">
            <label for="utmCampaign">utm_campaign</label>
            <input
              id="utmCampaign"
              type="text"
              formControlName="utmCampaign"
              placeholder="e.g., summer_sale">
          </div>
        </div>
      </fieldset>

      <!-- Dynamic Parameters Component -->
      <app-dynamic-params
        [paramsArray]="params"
        [onAdd]="onAddParameter.bind(this)"
        [onRemove]="onRemoveParameter.bind(this)">
      </app-dynamic-params>
    </form>

    <!-- Live URL Preview Component -->
    <app-url-preview
      [urlData]="constructedUrl()"
      [saveDisabled]="!canSave()"
      (copyClicked)="onCopyUrl()"
      (saveClicked)="onSaveBuild()">
    </app-url-preview>
  </div>

  <!-- History Component (Deferred Loading) -->
  <div class="history-area">
    @defer {
      <app-history (loadBuild)="onLoadBuild($event)"></app-history>
    } @placeholder {
      <div class="placeholder-card">Loading History...</div>
    } @error {
      <div class="error-card">Failed to load history.</div>
    }
  </div>
</main>
