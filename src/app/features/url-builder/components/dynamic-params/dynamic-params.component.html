<fieldset class="params-fieldset">
  <legend>{{ 'urlBuilder.form.customParams.legend' | translate }}</legend>

  @if (paramsArray().controls.length > 0) {
    <div class="params-list" role="list">
      @for (control of paramsArray().controls; track $index) {
        <div
          [formGroup]="getParamGroup($index)"
          class="param-group"
          role="listitem">

          <div class="param-input-group">
            <div class="input-wrapper">
              <label [for]="'param-key-' + $index" class="visually-hidden">
                {{ 'urlBuilder.form.customParams.key.label' | translate }} {{ $index + 1 }}
              </label>
              <input
                [id]="'param-key-' + $index"
                type="text"
                formControlName="key"
                [placeholder]="'urlBuilder.form.customParams.key.placeholder' | translate"
                class="param-input"
                [attr.aria-invalid]="hasError(getParamGroup($index), 'key')"
                [attr.aria-describedby]="hasError(getParamGroup($index), 'key') ? 'key-error-' + $index : null">
              @if (hasError(getParamGroup($index), 'key')) {
                <small [id]="'key-error-' + $index" class="error" role="alert">
                  {{ getErrorMessage(getParamGroup($index), 'key') }}
                </small>
              }
            </div>

            <div class="input-wrapper">
              <label [for]="'param-value-' + $index" class="visually-hidden">
                {{ 'urlBuilder.form.customParams.value.label' | translate }} {{ $index + 1 }}
              </label>
              <input
                [id]="'param-value-' + $index"
                type="text"
                formControlName="value"
                [placeholder]="'urlBuilder.form.customParams.value.placeholder' | translate"
                class="param-input"
                [attr.aria-invalid]="hasError(getParamGroup($index), 'value')"
                [attr.aria-describedby]="hasError(getParamGroup($index), 'value') ? 'value-error-' + $index : null">
              @if (hasError(getParamGroup($index), 'value')) {
                <small [id]="'value-error-' + $index" class="error" role="alert">
                  {{ getErrorMessage(getParamGroup($index), 'value') }}
                </small>
              }
            </div>
          </div>

          <button
            type="button"
            (click)="handleRemove($index)"
            class="remove-btn"
            tuiButton
            appearance="outline"
            size="s"
            [attr.aria-label]="('urlBuilder.form.customParams.removeButton' | translate) + ' ' + ($index + 1)"
            [title]="'urlBuilder.form.customParams.removeButton' | translate">
            &times;
          </button>
        </div>
      }
    </div>
  }

  <button
    type="button"
    (click)="handleAdd()"
    class="add-btn"
    tuiButton
    appearance="secondary"
    size="m"
    [attr.aria-label]="'urlBuilder.form.customParams.addButton' | translate">
    <svg class="add-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    {{ 'urlBuilder.form.customParams.addButton' | translate }}
  </button>

  @if (paramsArray().errors?.['duplicateKeys']; as error) {
    <div class="form-error" role="alert">
      <strong>{{ 'common.validation.duplicateKey' | translate }}:</strong> {{ error.duplicates.join(', ') }}
    </div>
  }
</fieldset>
